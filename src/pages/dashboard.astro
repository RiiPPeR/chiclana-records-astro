---
import Layout from "../layouts/Layout.astro"
import { RecordService } from "../lib/models/record"
import type { User } from "../lib/models/types/types"
import { supabase } from "../lib/supabase"
import type { Record } from './../lib/models/types/types';

const { cookies, redirect } = Astro

const accessToken = cookies.get("sb-access-token")
const refreshToken = cookies.get("sb-refresh-token")
const userCookie = cookies.get("user")

if (!accessToken || !refreshToken) {
    return redirect("/signin")
}

const user: User = userCookie ? JSON.parse(userCookie.value) : null
if (!user) {
    cookies.delete("sb-access-token", { path: "/" })
    cookies.delete("sb-refresh-token", { path: "/" })
    return redirect("/signin")
}

let session
try {
    session = await supabase.auth.setSession({
        refresh_token: refreshToken.value,
        access_token: accessToken.value,
    })
    if (session.error) {
        cookies.delete("sb-access-token", { path: "/" })
        cookies.delete("sb-refresh-token", { path: "/" })
        cookies.delete("user", { path: "/" })
        return redirect("/signin")
    }
} catch (error) {
    cookies.delete("sb-access-token", { path: "/" })
    cookies.delete("sb-refresh-token", { path: "/" })
    cookies.delete("user", { path: "/" })
    return redirect("/signin")
}
const recordService = new RecordService();

const email = session.data.user?.email
const userId = session.data.user?.id;

const records: Record[] = userId ? await recordService.getUserRecords(userId) : [];
---
<Layout title="Dashboard">
    <div id="container">
        <div class="">
            <h1>Bienvenido {email}</h1>
            <p>Tu nombre de usuario es: {user.username}</p>
            <h2>Tus discos</h2>
            <div class="flex flex-row flex-wrap gap-10 mr-24 ml-24">
                {records.map((record: Record) => (
                    <div class="flex-[1_1_500px] flex flex-row max-w-md mx-auto relative overflow-hidden z-10 bg-black bg-transparent backdrop-blur-md bg-opacity-30 p-4 rounded-lg shadow-xl transition-transform duration-300 hover:scale-105 cursor-pointer">
                        <div class="absolute w-24 h-24 bg-yellow-500 bg-opacity-50 rounded-full -z-10 blur-2xl top-20 right-0" />
                        <img src={record.image_url} alt="Imagel del disco" class="h-24 w-24" />
                        <div class="p-3 w-2/5">
                            <p>{record.artist}</p>
                            <p>{record.title}</p>
                            <p>{record.year}</p>
                        </div>
                        <div class="p-3 w-2/5">
                            <p>{record.label}</p>
                            <p>{record.catno}</p>
                            <p>{record.country}</p>
                        </div>
                    </div>
                ))}
            </div>
            <form action="/api/auth/signout">
                <button type="submit">Sign out</button>
            </form>
        </div>
    </div>
</Layout>
